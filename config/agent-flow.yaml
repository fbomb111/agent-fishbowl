# Agent Flow Graph — Machine-Readable Interaction Topology
#
# This file is the SINGLE SOURCE OF TRUTH for how agents interact.
# It drives:
#   1. Mermaid diagram generation (docs/agent-flow.md)
#   2. CI validation (scripts/validate-flow.py --validate)
#   3. CI freshness check (docs/agent-flow.md must match)
#
# When adding or modifying agents, update this file FIRST.
# Run: python scripts/validate-flow.py --validate
# Run: python scripts/validate-flow.py --mermaid -o docs/agent-flow.md

version: "2"

# All agent workflows must pin this harness version.
# Bump via: scripts/bump-harness.sh <new-version>
harness_ref: "@v1.6.1"

# ─── Event Registry ───────────────────────────────────────────────
# Every repository_dispatch event_type MUST be declared here.
# This prevents event name drift across workflows.

events:
  agent-product-owner-complete:
    description: "PO finished triaging — routed through issue-router to agent-po-engineer-work or agent-po-ops-work"
    payload: [chain_depth]
  agent-reviewer-feedback:
    description: "Reviewer requested changes on a PR"
    payload: [chain_depth]
  agent-product-manager-feedback:
    description: "PM flagged misalignment, PO should re-scope"
    status: stub  # planned: PM will dispatch to PO directly
  azure-alert:
    description: "Azure Monitor alert fired via alert bridge function"
    status: external  # sent by func-fishbowl-alert-bridge, not a workflow
  deploy-complete:
    description: "Deployment finished, triggers QA triage (deploy.yml → qa-triage.yml)"
    status: external  # flows between infrastructure workflows, not through agents
  pr-needs-review:
    description: "PR Manager flagged a PR for AI review (non-trivial risk)"
    payload: [pr_number, risk_level, chain_depth]
    status: external  # sent by pr-manager.yml infrastructure workflow
  dispute-detected:
    description: "Agent disagreement loop detected"
    status: stub  # receiver wired, no sender yet
  issue-labeled-engineer:
    description: "Router: assigned/engineer label applied"
    status: external  # sent by issue-router.yml
  issue-labeled-ops:
    description: "Router: assigned/ops label applied"
    status: external  # sent by issue-router.yml
  issue-labeled-po:
    description: "Router: assigned/po label applied — PO should triage"
    status: external  # sent by issue-router.yml
  issue-unlabeled-ops:
    description: "Router: status/blocked label removed"
    status: external  # sent by issue-router.yml
  issue-labeled-human-escalation:
    description: "Router: harness/request label applied"
    status: external  # sent by issue-router.yml
  ci-check-failed:
    description: "Router: CI check suite failed, engineer should investigate"
    payload: [head_sha, head_branch]
    status: external  # sent by issue-router.yml
  agent-tech-lead-complete:
    description: "Tech Lead scan completed with unprocessed intake — PO should triage"
    payload: []
  agent-po-engineer-work:
    description: "Router: PO complete, unassigned engineer-routed issues exist"
    payload: [chain_depth]
    status: external  # sent by issue-router.yml
  agent-po-ops-work:
    description: "Router: PO complete, unassigned ops-routed issues exist"
    payload: [chain_depth]
    status: external  # sent by issue-router.yml

# ─── Agent Nodes ──────────────────────────────────────────────────
#
# Schema (v2):
#   workflow:       GitHub Actions workflow filename
#   type:           custom | reusable (reusable = calls reusable-agent.yml)
#   timeout:        Job timeout in minutes
#   permissions:    Required GitHub token permissions
#   concurrency:    Concurrency group config (omit for reusable — inherits)
#   triggers:       List of event triggers matching the workflow's `on:` block
#   dispatches:     Outbound edges to other agents
#     location:     post_step (workflow step, validatable) | in_agent (Claude session, not validatable)
#   pre_steps:      Custom steps before the agent run (guard: true = can skip agent)
#   post_steps:     Custom steps after the agent run

agents:

  # ── Core Dev Loop ──

  triage:
    workflow: agent-triage.yml
    type: custom

    timeout: 20
    permissions:
      contents: read
      actions: write
    concurrency:
      group: agent-triage
      cancel_in_progress: false
    triggers:
      - type: issues
        actions: [opened]
      - type: schedule
        cron: "0 12 * * *"
      - type: workflow_dispatch
    dispatches:
      - target: product-owner
        method: workflow_run
        location: post_step
        condition:
          type: intake_batch
          threshold: 5
    pre_steps: []
    post_steps:
      - name: "Dispatch PO if intake batch ready"

  product-owner:
    workflow: agent-product-owner.yml
    type: custom

    timeout: 30
    permissions:
      contents: write
    concurrency:
      group: agent-product-owner
      cancel_in_progress: false
    triggers:
      - type: repository_dispatch
        event: agent-product-manager-feedback
      - type: repository_dispatch
        event: agent-tech-lead-complete
      - type: repository_dispatch
        event: issue-labeled-po
      - type: schedule
        cron: "0 6,18 * * *"
      - type: workflow_dispatch
    dispatches:
      - target: issue-router
        method: repository_dispatch
        event: agent-product-owner-complete
        location: in_agent
        note: "PO dispatches via dispatch-agent.sh; issue-router routes to agent-po-engineer-work or agent-po-ops-work"
        condition:
          type: unassigned_issues
          min: 1
        chain_depth: 1
      - target: user-experience
        method: workflow_run
        location: in_agent
        note: "PO prompt Step 8: >=3 merged frontend PRs or >2w since last UX review"
        condition:
          type: agent_driven
    pre_steps:
      - name: "Pre-flight — check if PO has work"
        guard: true
    post_steps: []

  engineer:
    workflow: agent-engineer.yml
    type: custom

    timeout: 30
    permissions:
      contents: read
      actions: write
    concurrency:
      group: agent-engineer
      cancel_in_progress: false
    triggers:
      - type: repository_dispatch
        event: issue-labeled-engineer
      - type: repository_dispatch
        event: agent-po-engineer-work
      - type: repository_dispatch
        event: agent-reviewer-feedback
      - type: repository_dispatch
        event: ci-check-failed
      - type: pull_request
        actions: [closed]
        branches: [main]
      - type: workflow_dispatch
    dispatches:
      - target: strategic
        method: workflow_run
        location: post_step
        condition:
          type: idle_backlog
          pm_cooldown_hours: 2
    pre_steps:
      - name: "Check for available work"
        guard: true
    post_steps:
      - name: "Signal low backlog — trigger PM"

  ops-engineer:
    workflow: agent-ops-engineer.yml
    type: reusable

    timeout: 30
    permissions:
      contents: read
    # concurrency: inherited from reusable-agent.yml → agent-ops-engineer
    triggers:
      - type: repository_dispatch
        event: issue-labeled-ops
      - type: repository_dispatch
        event: issue-unlabeled-ops
      - type: repository_dispatch
        event: agent-po-ops-work
      - type: workflow_dispatch
    dispatches: []

  reviewer:
    workflow: agent-reviewer.yml
    type: custom
    note: "AI code reviewer — only runs for flagged PRs (via pr-manager) or 12h sweep"

    timeout: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: write
    concurrency:
      group: agent-reviewer
      cancel_in_progress: false
    triggers:
      - type: repository_dispatch
        event: pr-needs-review
      - type: schedule
        cron: "0 */12 * * *"
      - type: workflow_dispatch
    dispatches:
      - target: engineer
        method: repository_dispatch
        event: agent-reviewer-feedback
        location: post_step
        condition:
          type: changes_requested
          min: 1
        chain_depth: increment
      - target: product-owner
        method: workflow_run
        location: post_step
        condition:
          type: intake_batch
          threshold: 5
      - target: tech-lead
        method: workflow_run
        location: post_step
        condition:
          type: untriaged_label
          label: "source/tech-lead"
          min: 1
    pre_steps: []
    post_steps:
      - name: "Free engineer from approved PRs"
      - name: "Dispatch PO if intake batch ready"
      - name: "Dispatch Tech Lead if new escalations exist"
      - name: "Dispatch feedback if changes requested"

  # ── Strategic / Intelligence ──

  strategic:
    workflow: agent-strategic.yml
    type: custom

    timeout: 30
    permissions:
      contents: read
    concurrency:
      group: agent-strategic
      cancel_in_progress: false
    triggers:
      - type: schedule
        cron: "0 5 * * *"
      - type: workflow_dispatch
    dispatches: []
    pre_steps: []
    post_steps: []

  tech-lead:
    description: "Tech Lead runs as multiple scheduled jobs, each a separate workflow"
    workflow: agent-scans.yml
    role: tech-lead

    jobs:
      full-scan:
        workflow: agent-scans.yml
        timeout: 45
        permissions:
          contents: write
        concurrency:
          group: agent-scans
          cancel_in_progress: false
        triggers:
          - type: schedule
            cron: "0 9 * * *"
          - type: workflow_dispatch
        dispatches:
          - target: product-owner
            method: repository_dispatch
            event: agent-tech-lead-complete
            location: post_step
            condition:
              type: intake_exists
        pre_steps: []
        post_steps:
          - name: "Dispatch PO if intake exists"
      architecture-review:
        workflow: agent-tech-lead-architecture.yml
        timeout: 45
        permissions:
          contents: write
        concurrency:
          group: agent-tech-lead-architecture
          cancel_in_progress: false
        triggers:
          - type: schedule
            cron: "0 7 * * *"
          - type: workflow_dispatch
        dispatches:
          - target: product-owner
            method: repository_dispatch
            event: agent-tech-lead-complete
            location: post_step
            condition:
              type: intake_exists
        pre_steps: []
        post_steps:
          - name: "Dispatch PO if intake exists"
      tech-debt-scan:
        workflow: agent-tech-lead-debt.yml
        timeout: 45
        permissions:
          contents: write
        concurrency:
          group: agent-tech-lead-debt
          cancel_in_progress: false
        triggers:
          - type: schedule
            cron: "0 8 * * *"
          - type: workflow_dispatch
        dispatches:
          - target: product-owner
            method: repository_dispatch
            event: agent-tech-lead-complete
            location: post_step
            condition:
              type: intake_exists
        pre_steps: []
        post_steps:
          - name: "Dispatch PO if intake exists"
      harness-request-review:
        workflow: agent-tech-lead-harness-review.yml
        timeout: 20
        permissions:
          contents: read
          issues: write
          actions: write
        concurrency:
          group: agent-tech-lead-harness-review
          cancel_in_progress: false
        triggers:
          - type: schedule
            cron: "0 14 * * *"
          - type: workflow_dispatch
        dispatches: []
        pre_steps:
          - name: "Check if any harness requests exist"
            guard: true
        post_steps: []
      security-scan:
        workflow: agent-tech-lead-security.yml
        timeout: 45
        permissions:
          contents: write
        concurrency:
          group: agent-tech-lead-security
          cancel_in_progress: false
        triggers:
          - type: schedule
            cron: "0 11 * * *"
          - type: workflow_dispatch
        dispatches:
          - target: product-owner
            method: repository_dispatch
            event: agent-tech-lead-complete
            location: post_step
            condition:
              type: intake_exists
        pre_steps: []
        post_steps:
          - name: "Dispatch PO if intake exists"
      qa-tooling-review:
        workflow: agent-tech-lead-qa-tooling.yml
        timeout: 45
        permissions:
          contents: write
        concurrency:
          group: agent-tech-lead-qa-tooling
          cancel_in_progress: false
        triggers:
          - type: schedule
            cron: "0 15 * * *"
          - type: workflow_dispatch
        dispatches:
          - target: product-owner
            method: repository_dispatch
            event: agent-tech-lead-complete
            location: post_step
            condition:
              type: intake_exists
        pre_steps: []
        post_steps:
          - name: "Dispatch PO if intake exists"
      infrastructure-review:
        workflow: agent-tech-lead-infrastructure.yml
        timeout: 45
        permissions:
          contents: write
        concurrency:
          group: agent-tech-lead-infrastructure
          cancel_in_progress: false
        triggers:
          - type: schedule
            cron: "0 13 * * *"
          - type: workflow_dispatch
        dispatches:
          - target: product-owner
            method: repository_dispatch
            event: agent-tech-lead-complete
            location: post_step
            condition:
              type: intake_exists
        pre_steps: []
        post_steps:
          - name: "Dispatch PO if intake exists"
      doc-review:
        workflow: agent-tech-lead-doc-review.yml
        timeout: 45
        permissions:
          contents: write
        concurrency:
          group: agent-tech-lead-doc-review
          cancel_in_progress: false
        triggers:
          - type: schedule
            cron: "0 16 * * *"
          - type: workflow_dispatch
        dispatches:
          - target: product-owner
            method: repository_dispatch
            event: agent-tech-lead-complete
            location: post_step
            condition:
              type: intake_exists
        pre_steps: []
        post_steps:
          - name: "Dispatch PO if intake exists"
      test-review:
        workflow: agent-tech-lead-test-review.yml
        timeout: 45
        permissions:
          contents: write
        concurrency:
          group: agent-tech-lead-test-review
          cancel_in_progress: false
        triggers:
          - type: schedule
            cron: "0 17 * * *"
          - type: workflow_dispatch
        dispatches:
          - target: product-owner
            method: repository_dispatch
            event: agent-tech-lead-complete
            location: post_step
            condition:
              type: intake_exists
        pre_steps: []
        post_steps:
          - name: "Dispatch PO if intake exists"
      project-structure-review:
        workflow: agent-tech-lead-structure-review.yml
        timeout: 45
        permissions:
          contents: write
        concurrency:
          group: agent-tech-lead-structure-review
          cancel_in_progress: false
        triggers:
          - type: schedule
            cron: "0 19 * * *"
          - type: workflow_dispatch
        dispatches:
          - target: product-owner
            method: repository_dispatch
            event: agent-tech-lead-complete
            location: post_step
            condition:
              type: intake_exists
        pre_steps: []
        post_steps:
          - name: "Dispatch PO if intake exists"
      pipeline-quality-review:
        workflow: agent-tech-lead-pipeline-quality.yml
        timeout: 45
        permissions:
          contents: write
        concurrency:
          group: agent-tech-lead-pipeline-quality
          cancel_in_progress: false
        triggers:
          - type: schedule
            cron: "0 20 * * *"
          - type: workflow_dispatch
        dispatches:
          - target: product-owner
            method: repository_dispatch
            event: agent-tech-lead-complete
            location: post_step
            condition:
              type: intake_exists
        pre_steps: []
        post_steps:
          - name: "Dispatch PO if intake exists"

  product-analyst:
    description: "Product Analyst runs as three jobs with distinct cadences"
    role: product-analyst

    jobs:
      product-discovery:
        workflow: agent-product-analyst-discovery.yml
        timeout: 30
        permissions:
          contents: read
          issues: write
        triggers:
          - type: schedule
            cron: "0 3 * * 1,3,5"  # Mon/Wed/Fri 03:00 UTC (before PM at 06:00)
          - type: workflow_dispatch
        dispatches: []
      market-intelligence:
        workflow: agent-product-analyst-intelligence.yml
        timeout: 30
        permissions:
          contents: read
          issues: write
        triggers:
          - type: schedule
            cron: "0 3 * * 2,4"    # Tue/Thu 03:00 UTC (before PM at 06:00)
          - type: workflow_dispatch
        dispatches: []
      revenue-operations:
        workflow: agent-product-analyst-revenue.yml
        timeout: 30
        permissions:
          contents: read
          issues: write
        triggers:
          - type: workflow_dispatch   # Manual only until Stripe is active
        dispatches: []

  financial-analyst:
    workflow: agent-financial-analyst.yml
    type: reusable

    timeout: 30
    permissions:
      contents: read
      issues: write
    # concurrency: inherited from reusable-agent.yml → agent-script (uses entry-point, not role)
    triggers:
      - type: schedule
        cron: "0 12 * * *"
      - type: workflow_dispatch
    dispatches: []

  marketing-strategist:
    workflow: agent-marketing-strategist.yml
    type: reusable

    timeout: 30
    permissions:
      contents: read
      issues: write
    # concurrency: inherited from reusable-agent.yml → agent-script (uses entry-point, not role)
    triggers:
      - type: schedule
        cron: "0 8 * * 1"
      - type: workflow_dispatch
    dispatches: []

  # ── Operations ──

  site-reliability:
    workflow: agent-site-reliability.yml
    type: custom

    timeout: 30
    permissions:
      contents: read
    concurrency:
      group: agent-sre
      cancel_in_progress: false
    triggers:
      - type: repository_dispatch
        event: azure-alert
      - type: schedule
        cron: "30 */4 * * *"
      - type: workflow_dispatch
    dispatches:
      - target: ingest
        method: workflow_run
        location: in_agent
        note: "SRE prompt Step 2: retrigger ingest if articles stale"
        condition:
          type: agent_driven
    pre_steps:
      - name: "Determine run mode"
    post_steps: []

  qa-analyst:
    workflow: agent-qa-analyst.yml
    type: custom

    timeout: 30
    permissions:
      contents: read
      issues: write
    concurrency:
      group: agent-qa-analyst
      cancel_in_progress: false
    triggers:
      - type: schedule
        cron: "0 16 * * *"
      - type: workflow_dispatch
    dispatches: []
    note: "Daily deep sweep. Post-deploy triage handled by qa-triage infrastructure workflow."

  customer-ops:
    workflow: agent-customer-ops.yml
    type: reusable

    timeout: 30
    permissions:
      contents: read
      issues: write
    # concurrency: inherited from reusable-agent.yml → agent-customer-ops
    triggers:
      - type: workflow_dispatch
    dispatches: []

  human-ops:
    workflow: agent-human-ops.yml
    type: reusable

    timeout: 30
    permissions:
      contents: read
      issues: write
    # concurrency: inherited from reusable-agent.yml → agent-human-ops
    triggers:
      - type: schedule
        cron: "0 15 * * 5"
      - type: workflow_dispatch
    dispatches: []

  escalation-lead:
    workflow: agent-escalation-lead.yml
    type: reusable

    timeout: 30
    permissions:
      contents: read
      issues: write
      pull-requests: write
    # concurrency: inherited from reusable-agent.yml → agent-escalation-lead
    triggers:
      - type: repository_dispatch
        event: dispute-detected
      - type: schedule
        cron: "0 18 * * 3"
      - type: workflow_dispatch
    dispatches: []

  # ── Content ──

  content-creator:
    workflow: agent-content-creator.yml
    type: custom

    timeout: 30
    permissions:
      contents: read
      issues: write
    concurrency:
      group: agent-content-creator
      cancel_in_progress: false
    triggers:
      - type: schedule
        cron: "0 10 * * *"
      - type: workflow_dispatch
    dispatches: []
    pre_steps: []
    post_steps: []

  user-experience:
    workflow: agent-user-experience.yml
    type: reusable

    timeout: 30
    permissions:
      contents: read
      issues: write
    # concurrency: inherited from reusable-agent.yml → agent-user-experience
    triggers:
      - type: schedule
        cron: "0 14 * * *"
      - type: workflow_dispatch
    dispatches: []

# ─── Infrastructure Workflows ─────────────────────────────────────
# Non-agent workflows that participate in the event graph.
# These are not agents but produce or consume events that agents react to.

infrastructure:
  deploy:
    workflow: deploy.yml
    note: "Paths-filtered (api/**, frontend/**) + workflow_dispatch. Dispatches deploy-complete after successful deploy."
  pr-manager:
    workflow: pr-manager.yml
    note: "PR risk assessment + auto-approve. Dispatches pr-needs-review for flagged PRs."
  qa-triage:
    workflow: qa-triage.yml
    note: "Post-deploy QA: runs scripts then AI triage. Triggered by deploy-complete."
  ingest:
    workflow: ingest.yml
    note: "SRE dispatch target — retriggered when articles are stale"
  ci:
    workflow: ci.yml
    note: "PR-only trigger (no push:main). check_suite failures routed to engineer via issue-router."
  issue-router:
    workflow: issue-router.yml
    note: "Central event router with per-issue concurrency (cancel-in-progress). Label events → batch dispatch, check_suite failures → ci-check-failed, agent-product-owner-complete → agent-po-engineer-work / agent-po-ops-work"

# ─── Safety Constraints ──────────────────────────────────────────
# Validated by scripts/validate-flow.py

safety:
  chain_depth_max: 5
  review_rounds_max: 3
