#!/bin/bash
# Auto-format staged Python files before commit.
# This hook runs ruff format + ruff check --fix so agents (and humans)
# cannot commit unformatted Python code.
set -uo pipefail

# --- Enforce wrapper usage ---
# Bare `git commit` is blocked. Use scripts/pre-commit.sh instead.
# The wrapper sets PRECOMMIT_WRAPPER=1 before calling git commit.
if [ "${PRECOMMIT_WRAPPER:-}" != "1" ]; then
    echo ""
    echo "ERROR: Bare 'git commit' is not allowed."
    echo "Use:  scripts/pre-commit.sh \"your commit message\""
    echo ""
    echo "The wrapper runs auto-fix + full quality checks before committing."
    exit 1
fi

# Resolve ruff: venv first, then system PATH
HOOK_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_ROOT="$(cd "$HOOK_DIR/.." && pwd)"
if [ -x "$PROJECT_ROOT/api/.venv/bin/ruff" ]; then
    RUFF="$PROJECT_ROOT/api/.venv/bin/ruff"
elif command -v ruff &>/dev/null; then
    RUFF="ruff"
else
    echo "pre-commit: ruff not found — skipping format check"
    exit 0
fi

STAGED_PY=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)
if [ -n "$STAGED_PY" ]; then
    # Auto-format
    $RUFF format $STAGED_PY
    # Auto-fix lint issues where possible
    $RUFF check --fix $STAGED_PY 2>/dev/null || true
    # Re-stage after formatting
    git add $STAGED_PY

    # Verify formatting is clean after auto-fix
    if ! $RUFF format --check $STAGED_PY 2>/dev/null; then
        echo ""
        echo "Pre-commit: ruff format --check failed after auto-fix. Some files need manual formatting."
        exit 1
    fi

    # Final lint check — abort commit if unfixable issues remain
    if ! $RUFF check $STAGED_PY; then
        echo ""
        echo "Pre-commit: ruff check failed. Fix lint errors before committing."
        exit 1
    fi
fi

# --- Frontend tests (vitest) ---
STAGED_TS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' || true)
if [ -n "$STAGED_TS" ]; then
    if [ -d "$PROJECT_ROOT/frontend" ] && [ -f "$PROJECT_ROOT/frontend/node_modules/.bin/vitest" ]; then
        echo "pre-commit: running frontend tests..."
        if ! (cd "$PROJECT_ROOT/frontend" && npx vitest run --reporter=verbose); then
            echo ""
            echo "Pre-commit: vitest failed. Fix frontend test failures before committing."
            exit 1
        fi
    fi
fi
