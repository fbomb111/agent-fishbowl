name: Issue Router

on:
  issues:
    types: [labeled, unlabeled]
  check_suite:
    types: [completed]
  repository_dispatch:
    types: [agent-product-owner-complete]

permissions:
  contents: write    # required for repository_dispatch via GITHUB_TOKEN

jobs:
  route:
    name: Route issue event
    if: github.event_name == 'issues'
    runs-on: self-hosted
    timeout-minutes: 5
    steps:
      - name: Route label event
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LABEL: ${{ github.event.label.name }}
          ACTION: ${{ github.event.action }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          dispatch() {
            echo "Routing $ACTION '$LABEL' on #$ISSUE_NUMBER → $1"
            gh api "repos/$GITHUB_REPOSITORY/dispatches" \
              --input - <<< "{
                \"event_type\": \"$1\",
                \"client_payload\": {
                  \"issue_number\": $ISSUE_NUMBER,
                  \"label_name\": \"$LABEL\",
                  \"action\": \"$ACTION\"
                }
              }"
          }

          if [ "$ACTION" = "labeled" ]; then
            case "$LABEL" in
              role/engineer)       dispatch "issue-labeled-engineer" ;;
              role/ops|priority/*) dispatch "issue-labeled-ops" ;;
              harness/request)     dispatch "issue-labeled-human-escalation" ;;
              *) echo "No route for label '$LABEL'" ;;
            esac
          elif [ "$ACTION" = "unlabeled" ]; then
            case "$LABEL" in
              status/blocked) dispatch "issue-unlabeled-ops" ;;
              *) echo "No route for unlabeled '$LABEL'" ;;
            esac
          fi

  route-ci:
    name: Route CI failure
    if: >
      github.event_name == 'check_suite' &&
      github.event.check_suite.conclusion == 'failure'
    runs-on: self-hosted
    timeout-minutes: 5
    steps:
      - name: Dispatch CI failure to engineer
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "CI failed (branch: ${{ github.event.check_suite.head_branch }}) — routing to engineer"
          gh api "repos/$GITHUB_REPOSITORY/dispatches" \
            --input - <<< '{
              "event_type": "ci-check-failed",
              "client_payload": {
                "head_sha": "${{ github.event.check_suite.head_sha }}",
                "head_branch": "${{ github.event.check_suite.head_branch }}"
              }
            }'

  route-po:
    name: Route PO complete
    if: >
      github.event_name == 'repository_dispatch' &&
      github.event.action == 'agent-product-owner-complete'
    runs-on: self-hosted
    timeout-minutes: 5
    steps:
      - name: Route to correct downstream agent(s)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CHAIN_DEPTH: ${{ github.event.client_payload.chain_depth || 0 }}
        run: |
          dispatch() {
            echo "Dispatching $1 (chain_depth=$CHAIN_DEPTH)"
            gh api "repos/$GITHUB_REPOSITORY/dispatches" \
              --input - <<< "{
                \"event_type\": \"$1\",
                \"client_payload\": {\"chain_depth\": $CHAIN_DEPTH}
              }"
          }

          # Unassigned engineer issues with priority
          ENG=$(gh issue list --state open --json assignees,labels \
            --jq '[.[] | select(
              (.assignees | length == 0) and
              (.labels | map(.name) | any(. == "role/engineer")) and
              (.labels | map(.name) | any(test("^priority/"))) and
              (.labels | map(.name) | any(. == "status/blocked") | not)
            )] | length')

          # Unassigned ops issues
          OPS=$(gh issue list --state open --json assignees,labels \
            --jq '[.[] | select(
              (.assignees | length == 0) and
              (.labels | map(.name) | any(. == "role/ops")) and
              (.labels | map(.name) | any(. == "status/blocked") | not)
            )] | length')

          echo "Engineer work: $ENG, Ops work: $OPS"
          [ "$ENG" -gt 0 ] && dispatch "agent-po-engineer-work"
          [ "$OPS" -gt 0 ] && dispatch "agent-po-ops-work"
          [ "$ENG" -eq 0 ] && [ "$OPS" -eq 0 ] && echo "No actionable work — no dispatch"
