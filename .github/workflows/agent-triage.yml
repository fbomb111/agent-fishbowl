name: Agent - Issue Triage

on:
  issues:
    types: [opened]
  schedule:
    - cron: "0 12 * * *"   # Daily at noon UTC — curate KB submissions
  workflow_dispatch: {}

permissions:
  contents: read
  actions: write          # gh workflow run agent-product-owner.yml

concurrency:
  group: agent-triage
  cancel-in-progress: false

jobs:
  triage:
    name: Run triage agent
    runs-on: self-hosted
    timeout-minutes: 20
    # Skip agent-created issues (they don't need triage)
    if: >
      github.event_name != 'issues' ||
      !contains(toJSON(github.event.issue.labels), 'agent-created')
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Run triage
        uses: YourMoveLabs/agent-harness@fdc364e879682d2068f72f13fecbf161574b1c1d  # v1.5.3
        with:
          entry-point: scripts/run-triage.sh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Dispatch PO if intake batch ready
        if: success()
        run: |
          # Count unprocessed intake: has source/* label but no priority/* yet
          INTAKE=$(gh issue list --state open --json labels \
            --jq '[.[] | select(
              (.labels | map(.name) | any(test("^source/"))) and
              (.labels | map(.name) | any(test("^priority/")) | not)
            )] | length')

          if [ "$INTAKE" -ge 5 ]; then
            echo "Batch ready: $INTAKE unprocessed intake items — dispatching PO"
            gh workflow run agent-product-owner.yml
          else
            echo "Only $INTAKE unprocessed items — accumulating (threshold: 5)"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
