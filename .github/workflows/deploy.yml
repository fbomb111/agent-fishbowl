name: Deploy

on:
  push:
    branches: [main]

permissions:
  contents: read
  issues: write

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy-api:
    name: Deploy API
    runs-on: self-hosted
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Azure login (Managed Identity)
        run: |
          az login --identity --client-id ${{ secrets.MANAGED_IDENTITY_CLIENT_ID }}
          az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Build and push API image
        run: |
          az acr login --name agentfishbowlacr
          docker build \
            -t agentfishbowlacr.azurecr.io/agent-fishbowl-api:${{ github.sha }} \
            -t agentfishbowlacr.azurecr.io/agent-fishbowl-api:latest \
            -f api/Dockerfile .
          # Push specific tags only (not --all-tags which tries to push all 40+ old commit tags)
          docker push agentfishbowlacr.azurecr.io/agent-fishbowl-api:${{ github.sha }}
          docker push agentfishbowlacr.azurecr.io/agent-fishbowl-api:latest

          echo "### API Deploy" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Image**: \`agentfishbowlacr.azurecr.io/agent-fishbowl-api:${GITHUB_SHA::8}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Commit**: [\`${GITHUB_SHA::8}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> "$GITHUB_STEP_SUMMARY"

      - name: Update Container App
        run: |
          az containerapp update \
            --name ca-agent-fishbowl-api \
            --resource-group rg-agent-fishbowl \
            --image agentfishbowlacr.azurecr.io/agent-fishbowl-api:${{ github.sha }}

      - name: Verify deployment
        id: health
        continue-on-error: true
        run: |
          echo "Verifying API health..."
          for i in 1 2 3 4 5; do
            if curl -sf --max-time 10 https://api.agentfishbowl.com/api/fishbowl/health; then
              echo ""
              echo "API is healthy!"
              echo "- **Health**: Healthy" >> "$GITHUB_STEP_SUMMARY"
              exit 0
            fi
            echo "Attempt $i/5 failed, waiting 15s..."
            sleep 15
          done
          echo "- **Health**: FAILED (rolled back)" >> "$GITHUB_STEP_SUMMARY"
          echo "ERROR: API health check failed after 5 attempts"
          exit 1

      - name: Rollback on failure
        if: steps.health.outcome == 'failure'
        run: |
          echo "Health check failed — rolling back to previous revision"
          PREV=$(az containerapp revision list \
            --name ca-agent-fishbowl-api \
            --resource-group rg-agent-fishbowl \
            --query "sort_by([?properties.active], &properties.createdTime)[-2].name" -o tsv)
          if [ -n "$PREV" ]; then
            az containerapp ingress traffic set \
              --name ca-agent-fishbowl-api \
              --resource-group rg-agent-fishbowl \
              --revision-weight "$PREV=100"
            echo "Rolled back to revision: $PREV"
          else
            echo "WARNING: No previous revision found — cannot auto-rollback"
          fi

      - name: Fail job if unhealthy
        if: steps.health.outcome == 'failure'
        run: exit 1

      - name: Clean up old Docker images
        if: always()
        run: |
          # Remove old API image tags to prevent accumulation on self-hosted runner
          docker images agentfishbowlacr.azurecr.io/agent-fishbowl-api \
            --format '{{.Repository}}:{{.Tag}}' \
            | grep -v ':${{ github.sha }}' \
            | grep -v ':latest' \
            | grep -v ':<none>' \
            | xargs -r docker rmi 2>/dev/null || true

          REMAINING=$(docker images agentfishbowlacr.azurecr.io/agent-fishbowl-api --format '{{.Tag}}' | wc -l)
          echo "Docker images remaining: $REMAINING"

  deploy-frontend:
    name: Deploy Frontend
    runs-on: self-hosted
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build
        env:
          NEXT_PUBLIC_API_URL: https://api.agentfishbowl.com

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.SWA_DEPLOY_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: upload
          app_location: frontend/out
          output_location: ""
          skip_app_build: true
          is_static_export: true

      - name: Post frontend deploy summary
        if: success()
        run: |
          echo "### Frontend Deploy" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Target**: Azure Static Web Apps" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Status**: Deployed" >> "$GITHUB_STEP_SUMMARY"

  notify-failure:
    name: Create issue on deploy failure
    runs-on: self-hosted
    timeout-minutes: 15
    needs: [deploy-api, deploy-frontend]
    if: failure()
    steps:
      - uses: actions/checkout@v4
      - name: Create deploy failure issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Deduplicate: if an open deploy-failure issue exists, comment instead of creating
          EXISTING=$(gh issue list --label "deploy-failure" --state open --limit 1 --json number --jq '.[0].number // empty')
          if [ -n "$EXISTING" ]; then
            echo "Deploy failure issue #$EXISTING already open — adding comment"
            gh issue comment "$EXISTING" --body "Another deploy failed for commit \`${GITHUB_SHA::8}\`. [View run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            exit 0
          fi

          gh issue create \
            --title "Deploy failure: ${GITHUB_SHA::8}" \
            --label "priority/high,type/bug,deploy-failure" \
            --body "## Deploy Failed

          **Commit**: ${{ github.sha }}
          **Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Check the workflow logs above to identify the failing step and fix it.

          This issue was auto-created by the deploy workflow."
