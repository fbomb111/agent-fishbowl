name: Deploy

on:
  push:
    branches: [main]

permissions:
  contents: read
  issues: write

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy-api:
    name: Deploy API
    runs-on: self-hosted
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Azure login (Managed Identity)
        run: az login --identity --client-id ${{ secrets.MANAGED_IDENTITY_CLIENT_ID }}

      - name: Build and push API image
        run: |
          az acr login --name agentfishbowlacr
          docker build \
            -t agentfishbowlacr.azurecr.io/agent-fishbowl-api:${{ github.sha }} \
            -t agentfishbowlacr.azurecr.io/agent-fishbowl-api:latest \
            -f api/Dockerfile .
          docker push agentfishbowlacr.azurecr.io/agent-fishbowl-api --all-tags

      - name: Update Container App
        run: |
          az containerapp update \
            --name ca-agent-fishbowl-api \
            --resource-group rg-agent-fishbowl \
            --image agentfishbowlacr.azurecr.io/agent-fishbowl-api:${{ github.sha }}

      - name: Verify deployment
        id: health
        continue-on-error: true
        run: |
          echo "Verifying API health..."
          for i in 1 2 3 4 5; do
            if curl -sf --max-time 10 https://api.agentfishbowl.com/api/fishbowl/health; then
              echo ""
              echo "API is healthy!"
              exit 0
            fi
            echo "Attempt $i/5 failed, waiting 15s..."
            sleep 15
          done
          echo "ERROR: API health check failed after 5 attempts"
          exit 1

      - name: Rollback on failure
        if: steps.health.outcome == 'failure'
        run: |
          echo "Health check failed — rolling back to previous revision"
          PREV=$(az containerapp revision list \
            --name ca-agent-fishbowl-api \
            --resource-group rg-agent-fishbowl \
            --query "sort_by([?properties.active], &properties.createdTime)[-2].name" -o tsv)
          if [ -n "$PREV" ]; then
            az containerapp ingress traffic set \
              --name ca-agent-fishbowl-api \
              --resource-group rg-agent-fishbowl \
              --revision-weight "$PREV=100"
            echo "Rolled back to revision: $PREV"
          else
            echo "WARNING: No previous revision found — cannot auto-rollback"
          fi

      - name: Fail job if unhealthy
        if: steps.health.outcome == 'failure'
        run: exit 1

  deploy-frontend:
    name: Deploy Frontend
    runs-on: self-hosted
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build
        env:
          NEXT_PUBLIC_API_URL: https://api.agentfishbowl.com

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.SWA_DEPLOY_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: upload
          app_location: frontend/out
          output_location: ""
          skip_app_build: true
          is_static_export: true

  notify-failure:
    name: Create issue on deploy failure
    runs-on: self-hosted
    timeout-minutes: 15
    needs: [deploy-api, deploy-frontend]
    if: failure()
    steps:
      - uses: actions/checkout@v4
      - name: Create deploy failure issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "Deploy failure: ${GITHUB_SHA::8}" \
            --label "priority/high,type/bug,deploy-failure" \
            --body "## Deploy Failed

          **Commit**: ${{ github.sha }}
          **Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Check the workflow logs above to identify the failing step and fix it.

          This issue was auto-created by the deploy workflow."
