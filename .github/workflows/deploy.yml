name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy-api:
    name: Deploy API
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Build and push API image
        run: |
          az acr login --name agentfishbowlacr
          docker build \
            -t agentfishbowlacr.azurecr.io/agent-fishbowl-api:${{ github.sha }} \
            -t agentfishbowlacr.azurecr.io/agent-fishbowl-api:latest \
            -f api/Dockerfile .
          docker push agentfishbowlacr.azurecr.io/agent-fishbowl-api --all-tags

      - name: Update Container App
        run: |
          az containerapp update \
            --name ca-agent-fishbowl-api \
            --resource-group rg-agent-fishbowl \
            --image agentfishbowlacr.azurecr.io/agent-fishbowl-api:${{ github.sha }}

      - name: Verify deployment
        run: |
          echo "Waiting for container to start..."
          sleep 15
          curl -sf https://ca-agent-fishbowl-api.victoriousground-9f7e15f3.eastus.azurecontainerapps.io/api/articles \
            && echo "API is responding" \
            || echo "WARNING: API health check failed (may still be starting)"

  deploy-frontend:
    name: Deploy Frontend
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build
        env:
          NEXT_PUBLIC_API_URL: https://ca-agent-fishbowl-api.victoriousground-9f7e15f3.eastus.azurecontainerapps.io

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.SWA_DEPLOY_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: upload
          app_location: frontend/out
          output_location: ""
          skip_app_build: true
          is_static_export: true

  notify-failure:
    name: Create issue on deploy failure
    runs-on: self-hosted
    needs: [deploy-api, deploy-frontend]
    if: failure()
    steps:
      - uses: actions/checkout@v4
      - name: Create deploy failure issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "Deploy failure: ${GITHUB_SHA::8}" \
            --label "priority/high,type/bug,deploy-failure" \
            --body "## Deploy Failed

          **Commit**: ${{ github.sha }}
          **Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Check the workflow logs above to identify the failing step and fix it.

          This issue was auto-created by the deploy workflow."
