name: CI

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  api-lint:
    name: API Lint & Test
    runs-on: self-hosted
    timeout-minutes: 10
    if: >
      github.event_name != 'pull_request' ||
      github.event.pull_request.head.repo.full_name == github.repository
    defaults:
      run:
        working-directory: api
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5
        with:
          python-version: "3.12"
      - run: pip install -r requirements.txt ruff pip-audit
      - run: python -m ruff check .
      - run: python -m ruff format --check .
      - name: Run pytest
        working-directory: .
        run: python -m pytest api/tests/ -v --tb=short
      - name: Audit Python dependencies
        run: pip-audit -r requirements.txt
        continue-on-error: true

  frontend-lint:
    name: Frontend Lint & Typecheck
    runs-on: self-hosted
    timeout-minutes: 10
    if: >
      github.event_name != 'pull_request' ||
      github.event.pull_request.head.repo.full_name == github.repository
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - run: npm ci
      - run: npx eslint .
      - run: npx tsc --noEmit
      - run: npx vitest run --reporter=verbose
      - name: Audit npm dependencies
        run: npm audit --audit-level=high

  flow-validation:
    name: Validate Agent Flow Graph
    runs-on: self-hosted
    timeout-minutes: 5
    if: >
      github.event_name != 'pull_request' ||
      github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5
        with:
          python-version: "3.12"
      - run: pip install pyyaml

      - name: Validate flow graph
        run: python scripts/validate-flow.py --validate

      - name: Check diagram freshness
        run: |
          set -e
          python scripts/validate-flow.py --mermaid -o /tmp/agent-flow.md
          # Strip timestamp lines before comparing (they change every run)
          grep -v '<!-- Last generated:' /tmp/agent-flow.md > /tmp/flow-new.md
          grep -v '<!-- Last generated:' docs/agent-flow.md > /tmp/flow-old.md
          diff -q /tmp/flow-new.md /tmp/flow-old.md || {
            echo "::error::Flow diagram is stale. Run: python scripts/validate-flow.py --mermaid -o docs/agent-flow.md"
            exit 1
          }

  notify-ci-failure:
    name: Notify CI failure
    runs-on: self-hosted
    needs: [api-lint, frontend-lint, flow-validation]
    if: failure() && github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4
      - name: Label PR and notify
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR=${{ github.event.pull_request.number }}
          gh pr edit "$PR" --add-label "ci/failed"
          gh pr comment "$PR" --body "CI failed â€” see check results above. The engineer should fix and push."
