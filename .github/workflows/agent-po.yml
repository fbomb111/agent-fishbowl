name: Agent - Product Owner

on:
  repository_dispatch:
    types: [agent-pm-feedback]
  schedule:
    - cron: "0 6,18 * * *"   # Every 12 hours (sweep runs)
  workflow_dispatch: {}        # Manual or batch-threshold dispatch

permissions:
  contents: write        # dispatch-agent.sh (repository_dispatch)

concurrency:
  group: agent-po
  cancel-in-progress: false

jobs:
  po:
    name: Run PO agent
    runs-on: self-hosted
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Pre-flight — check if PO has work
        id: preflight
        if: github.event_name != 'schedule'
        run: |
          # Count unprocessed intake (source/* without priority/*)
          INTAKE=$(gh issue list --state open --json labels \
            --jq '[.[] | select(
              (.labels | map(.name) | any(test("^source/"))) and
              (.labels | map(.name) | any(test("^priority/")) | not)
            )] | length')

          # Count PM-flagged misaligned issues
          MISALIGNED=$(gh issue list --state open --label "pm/misaligned" \
            --json number --jq length)

          echo "intake=$INTAKE misaligned=$MISALIGNED"

          if [ "$((INTAKE + MISALIGNED))" -eq 0 ]; then
            echo "No intake or misaligned issues — skipping PO run"
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "PO has work: $INTAKE intake + $MISALIGNED misaligned"
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run PO agent
        if: github.event_name == 'schedule' || steps.preflight.outputs.skip != 'true'
        uses: YourMoveLabs/agent-harness@v1.1.0
        with:
          entry-point: agents/po.sh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Dispatch to engineer if work available
        if: success()
        run: |
          UNASSIGNED=$(gh issue list --state open --json assignees --jq '[.[] | select(.assignees | length == 0)] | length' 2>/dev/null || echo "0")
          if [ "$UNASSIGNED" -gt 0 ]; then
            gh api "repos/$GITHUB_REPOSITORY/dispatches" \
              --input - <<< '{"event_type":"agent-po-complete","client_payload":{"chain_depth":1}}'
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup workspace
        if: always()
        run: |
          git gc --auto --quiet 2>/dev/null || true
          git worktree prune 2>/dev/null || true
          NPM_SIZE=$(du -sm ~/.npm 2>/dev/null | cut -f1)
          if [ "${NPM_SIZE:-0}" -gt 500 ]; then
            npm cache clean --force 2>/dev/null || true
          fi
