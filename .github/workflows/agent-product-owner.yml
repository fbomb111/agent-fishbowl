name: Agent - Product Owner

on:
  repository_dispatch:
    types: [agent-product-manager-feedback, agent-tech-lead-complete]
  schedule:
    - cron: "0 6,18 * * *"   # Every 12 hours (sweep runs)
  workflow_dispatch: {}        # Manual or batch-threshold dispatch

permissions:
  contents: write        # dispatch-agent.sh (repository_dispatch)

concurrency:
  group: agent-product-owner
  cancel-in-progress: false

jobs:
  product-owner:
    name: Run Product Owner agent
    runs-on: self-hosted
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Pre-flight — check if PO has work
        id: preflight
        if: github.event_name == 'repository_dispatch'
        run: |
          # Count unprocessed intake (source/* without priority/*)
          INTAKE=$(gh issue list --state open --json labels \
            --jq '[.[] | select(
              (.labels | map(.name) | any(test("^source/"))) and
              (.labels | map(.name) | any(test("^priority/")) | not)
            )] | length')

          # Count PM-flagged misaligned issues
          MISALIGNED=$(gh issue list --state open --label "product-manager/misaligned" \
            --json number --jq length)

          echo "intake=$INTAKE misaligned=$MISALIGNED"

          if [ "$((INTAKE + MISALIGNED))" -eq 0 ]; then
            echo "No intake or misaligned issues — skipping PO run"
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "PO has work: $INTAKE intake + $MISALIGNED misaligned"
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Product Owner agent
        if: github.event_name == 'schedule' || steps.preflight.outputs.skip != 'true'
        uses: YourMoveLabs/agent-harness@fcb5e86f2cce015c7df88ae190b5030b3522fce1  # v1.6.1
        with:
          role: product-owner
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

